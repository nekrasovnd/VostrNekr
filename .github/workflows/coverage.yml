name: Code Coverage

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Debug - Show directory structure
      run: |
        echo "=== Directory Structure ==="
        ls -la
        echo "=== JS files ==="
        find . -name "*.js" -type f
        echo "=== Test files ==="
        ls -la test/
        
    - name: Debug - Check calculator.js exports
      run: |
        echo "=== Checking calculator.js ==="
        tail -10 js/calculator.js
        echo "=== Testing require ==="
        node -e "console.log('Testing require...'); try { const calc = require('./js/calculator.js'); console.log('✅ Require successful'); console.log('Exports:', Object.keys(calc)); } catch(e) { console.log('❌ Require failed:', e.message); }"
        
    - name: Install dependencies
      run: npm install
      
    - name: Run basic test without coverage
      run: |
        echo "=== Running basic test ==="
        node test/coverage-test.js
        echo "Test exit code: True"
        
    - name: Install c8
      run: npm install -g c8
      
    - name: Run tests with coverage
      run: |
        echo "=== Running with coverage ==="
        c8 node test/coverage-test.js
      
    - name: Generate coverage report
      run: c8 report --reporter=html --reporter=text
      
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30
